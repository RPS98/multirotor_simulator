# quadrotor_model
C++ Quadrotor Model

The purpose of this repository is to provide a quadrotor model, implemented in c++.

The objective of the model is that given a state of the quadrotor and an action, to calculate the evolution of the state. For this purpose, the state, actuation and dynamics of the system must be defined.

## Table of Contents  
- [1. Quadrotor State](#1-quadrotor-state)
    - [1.1 Kinematics](#11-kinematics)
    - [1.2 Dynamics](#12-dynamics)
    - [1.3 Actuation](#13-actuation)
- [2. Quadrotor Actuation](#2-quadrotor-actuation)
- [3. Quadrotor Dynamics](#3-quadrotor-dynamics)



## 1. Quadrotor State

Quadrotor is a rigid body, which mass center is the origin of the body frame. 

### 1.1 Kinematics
The state from the point of view of kinematics can be defined as:

* **Position** $$ \mathbf{p} = [x, y, z] $$
* **Attitude** $$ \mathbf{q} = [\theta_x, \theta_y, \theta_z] = [w, q_1, q_2, q_3] $$
* **Velocity** $$ \mathbf{v} = [v_x, v_y, v_z] $$
* **Angular velocity** $$ \mathbf{\omega} = [\omega_x, \omega_y, \omega_z] $$
* **Linear acceleration** $$ \mathbf{a} = [a_x, a_y, a_z] $$
* **Angular acceleration** $$ \mathbf{\alpha} = [\alpha_x, \alpha_y, \alpha_z] $$

### 1.2 Dynamics
The state from the point of view of dynamics can be defined as:

* **Force** $$ \mathbf{F} = [F_x, F_y, F_z] $$
* **Torque** $$ \mathbf{\tau} = [\tau_x, \tau_y, \tau_z] $$

### 1.3 Actuation
The state from the point of view of actuation can be defined as:

* **Motor angular velocity** $$ \mathbf{\omega_m} = [\omega_1, \omega_2, \omega_3, \omega_4] $$

## 2. Quadrotor Actuation

The are several ways to define the actuation of a quadrotor. The lowest level of abstraction is the motor angular velocity, which is the input of the motors.

Some of the most common actuation modes are, from lowest to highest level of abstraction:

* **Motor angular velocity** $$ \mathbf{\omega_m} = [\omega_1, \omega_2, \omega_3, \omega_4] $$
* **Acro mode** $$ \mathbf{Acro} = [\mathbf{T}, \omega_x, \omega_y, \omega_z] $$
* **Attitude mode** $$ \mathbf{Attitude} = [\mathbf{T}, \theta_x, \theta_y, \theta_z] $$
* **Speed mode** $$ \mathbf{v} = [v_x, v_y, v_z, \omega_z] $$
* **Position mode** $$ \mathbf{p} = [x, y, z, \theta_z] $$

For the purpose of this model, the actuation will be defined as the Acro mode, because it is the lowest level used in most of autonomous flight controllers.

$$ \mathbf{U} = [\mathbf{U_T}, \mathbf{U_\omega}] = [\mathbf{T}, \omega_x, \omega_y, \omega_z] $$

## 3. Quadrotor Dynamics


In the Figure below, the quadrotor is represented as a rigid body, with the mass center as the origin of the body frame. 

*F<sub>m</sub>=[F<sub>1</sub>, F<sub>2</sub>, F<sub>3</sub>, F<sub>4</sub>]* is the force applied by each motor, and *r* is the distance from the mass center to the motor. *τ<sub>m</sub>=[τ<sub>1</sub>, τ<sub>2</sub>, τ<sub>3</sub>, τ<sub>4</sub>]* is the torque applied by each motor.

*F<sub>B</sub>=[F<sub>x</sub>, F<sub>y</sub>, F<sub>z</sub>]* is the force applied by the propellers, and *τ<sub>B</sub>=[τ<sub>x</sub>, τ<sub>y</sub>, τ<sub>z</sub>]* is the torque applied by the propeller to the quadrotor body frame.

![quadrotor_scheme](resources/quadrotor_scheme.svg)

Been *k<sub>f</sub>* the thrust coefficient and *k<sub>t</sub>* the torque coefficient, the force and torque applied by each motor can be calculated as:

* Force:

$$ F_1 = k_f \cdot \omega_1^2 $$
$$ F_2 = k_f \cdot \omega_2^2 $$
$$ F_3 = k_f \cdot \omega_3^2 $$
$$ F_4 = k_f \cdot \omega_4^2 $$

$$ F_m = [F_1, F_2, F_3, F_4] = k_f \cdot [\omega_1^2, \omega_2^2, \omega_3^2, \omega_4^2] $$

* Torque:

$$ \tau_1 = k_t \cdot \omega_1^2 $$
$$ \tau_2 = k_t \cdot \omega_2^2 $$
$$ \tau_3 = k_t \cdot \omega_3^2 $$
$$ \tau_4 = k_t \cdot \omega_4^2 $$
$$ \tau_m = [ \tau_1, \tau_2, \tau_3, \tau_4 ] = k_t \cdot [ \omega_1^2, \omega_2^2, \omega_3^2, \omega_4^2 ] $$


So, we have a relation between the motor angular velocity and the force and torque generated by the propellers.

We can convert the force *F<sub>m</sub>* and torque *τ<sub>m</sub>* applied by the propellers to the force *F<sub>B</sub>* and torque *τ<sub>B</sub>* applied to the quadrotor body frame. Using the Figure before, be can define the force relation as:

$$
\begin{bmatrix} 
F_x \\ F_y \\ F_z 
\end{bmatrix}
= 
\begin{bmatrix}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\ 
1 & 1 & 1 & 1
\end{bmatrix}
\cdot
\begin{bmatrix}
F_1 \\ F_2 \\ F_3 \\ F_4
\end{bmatrix}
$$


And the torque relation as:

$$
\begin{bmatrix} 
\tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
=
\begin{bmatrix}
0 & d_y & 0 & -d_y \\
-d_x & 0 & d_x & 0 \\
0 & 0 & 0 & 0
\end{bmatrix}
\cdot 
\begin{bmatrix}
F_1 \\ F_2 \\ F_3 \\ F_4
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\ 
1 & -1 & 1 & -1
\end{bmatrix}
\cdot 
\begin{bmatrix}
\tau_1 \\ \tau_2 \\ \tau_3 \\ \tau_4
\end{bmatrix}
$$

We can sustitute the force of each motor and the torque of each motor for the angular velocity of each motor:

$$
\begin{bmatrix} 
F_x \\ F_y \\ F_z 
\end{bmatrix}
=
\begin{bmatrix}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
k_f & k_f & k_f & k_f
\end{bmatrix}
\cdot
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
$$

$$
\begin{bmatrix} 
\tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
=
\begin{bmatrix}
0 & d_y \cdot k_f & 0 & -d_y \cdot k_f \\
-d_x \cdot k_f & 0 & d_x \cdot k_f & 0 \\
0 & 0 & 0 & 0
\end{bmatrix}
\cdot
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
k_t & -k_t & k_t & -k_t
\end{bmatrix}
\cdot
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
$$

So, we can calculate the force and torque applied by the propellers to the quadrotor body frame by the angular velocity of each motor:

$$
\begin{bmatrix} 
F_z \\ \tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
=
\begin{bmatrix}
k_f & k_f & k_f & k_f \\
0 & d_y \cdot k_f & 0 & -d_y \cdot k_f \\
-d_x \cdot k_f & 0 & d_x \cdot k_f & 0 \\
k_t & -k_t & k_t & -k_t
\end{bmatrix}
\cdot
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
$$

Also, we can calculate the angular velocity of each motor by the force and torque applied by the propellers to the quadrotor body frame:

$$
\begin{bmatrix} 
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2 
\end{bmatrix}
=
\begin{bmatrix}
k_f & k_f & k_f & k_f \\
0 & d_y \cdot k_f & 0 & -d_y \cdot k_f \\
-d_x \cdot k_f & 0 & d_x \cdot k_f & 0 \\
k_t & -k_t & k_t & -k_t
\end{bmatrix}^{-1}
\cdot
\begin{bmatrix} 
F_z \\ \tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
$$










# TODO:

Kinetic momentum of a rigid body

$$ L=I \cdot \omega $$

Equation of motion

$$ \frac{d}{dt} L = \frac{d}{dt} [I(t) \cdot w(t)] $$

The inertia matrix depends on time, so we can't use the constant inertia matrix

$$ \frac{d}{dt} L \neq I \cdot \frac{d}{dt} w(t) $$

The inertia matrix is a function of the angular velocity

$$ \frac{d}{dt} L = I \cdot \frac{d}{dt} w(t) + w(t) \times I \cdot w(t) $$

Where $$ w(t) \times I \cdot w(t) $$ is due to the Coriolis effect.

![quadrotor_scheme](resources/quadrotor_motor.svg)

$$ Thrust = F_1 + F_2 + F_3 + F_4 = k_f \cdot \omega_1^2 + k_f \cdot \omega_2^2 + k_f \cdot \omega_3^2 + k_f \cdot \omega_4^2 = k_f \cdot (\omega_1^2 + \omega_2^2 + \omega_3^2 + \omega_4^2) $$


$$ \tau_x = F_2 \cdot r - F_4 \cdot r = r \cdot (F_2 - F_4) = r \cdot (k_f \cdot \omega_2^2 - k_f \cdot \omega_4^2) = r \cdot k_f \cdot (\omega_2^2 - \omega_4^2) $$

$$ \tau_y = F_3 \cdot r - F_1 \cdot r = r \cdot (F_3 - F_1) = r \cdot (k_f \cdot \omega_3^2 - k_f \cdot \omega_1^2) = r \cdot k_f \cdot (\omega_3^2 - \omega_1^2) $$

$$ \tau_z = T_1 - T_2 + T_3 - T_4 = K_t \cdot \omega_1^2 - K_t \cdot \omega_2^2 + K_t \cdot \omega_3^2 - K_t \cdot \omega_4^2 = K_t \cdot (\omega_1^2 - \omega_2^2 + \omega_3^2 - \omega_4^2) $$

In a Matrix:

$$ 
\begin{bmatrix} \tau_x \\ \tau_y \\ \tau_z \end{bmatrix} 
= 
\begin{bmatrix}
0 & r \cdot k_f & 0 & -r \cdot k_f \\
-r \cdot k_f & 0 & r \cdot k_f & 0 \\
k_t & -k_t & k_t & -k_t 
\end{bmatrix} 
\cdot 
\begin{bmatrix} 
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2 
\end{bmatrix} 
$$

Including Thrust:

$$ 
\begin{bmatrix} 
T \\ \tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
=
\begin{bmatrix}
k_f & k_f & k_f & k_f \\
0 & r \cdot k_f & 0 & -r \cdot k_f \\
-r \cdot k_f & 0 & r \cdot k_f & 0 \\
k_t & -k_t & k_t & -k_t 
\end{bmatrix}
\cdot
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
$$


We have the desired Thrust and torque, and we want to find the angular velocity of the motors.

$$ 
\begin{bmatrix}
\omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2
\end{bmatrix}
=
\begin{bmatrix}
k_f & k_f & k_f & k_f \\
0 & r \cdot k_f & 0 & -r \cdot k_f \\
-r \cdot k_f & 0 & r \cdot k_f & 0 \\
k_t & -k_t & k_t & -k_t 
\end{bmatrix}^{-1}
\cdot
\begin{bmatrix} 
T \\ \tau_x \\ \tau_y \\ \tau_z 
\end{bmatrix}
$$
